# .pgpass密码文件使用
- author：Hanson Huang
- date：2019.08.16
- label：greenplum， PostgreSQL，.pgpass， 无密访问

## 密码文件的应用场景
出于安全考虑，设置PostgreSQL密码口令的访问认证，
对于一些没有密码选项的客户端工具，比如
- pg_basebackup备份工具。
- pg_dumpall工具，转储一个数据库集群里的所有数据库到一个脚本文件。pg_dumpall需要和PostgreSQL 服务器连接多次(每个数据库一次)。如果你使用口令认证，可能每次都会询问口令。 

这些情况下写一个~/.pgpass可能会比较方便。 

## 密码文件的创建
密码文件创建在客户端的机器上，
格式：

```
hostname:port:database:username:password
```
由5个域组成，前4个域是要访问的目标，可以是具体值或者匹配任何值的*。创建好~/.pgpass，修改其访问权限，chmod
0600 ~/.pgpass 或 chmod
0400 ~/.pgpass。

## 示例
> Client IP：192.168.0.102
> 
> Server IP：192.168.0.101  DB：postgres  User：hanson   password：123456

1. 在 192.168.0.102 客户端访问服务端

```shell
[hanson@sdw1 ~]$ psql postgres -h192.168.0.101
Password:
```
因为没有密码文件，所以访问需要密码，下面创建密码文件再进行访问。

2. 在 192.168.0.102 客户端创建 ~/.pgpass

```
192.168.0.101:5432:postgres:hanson:123456
```


3. 修改 ~/.pgpass 访问权限

```shell
[hanson@sdw1 ~]$ chmod 400 .pgpass
```

4. 在 192.168.0.102 客户端访问服务端

```
[hanson@sdw1 ~]$ psql postgres -h192.168.0.101
psql (8.3.23)
Type "help" for help.

postgres=#
```
有了密码文件之后，可以免密连接服务端。

## 问题
在客户端创访问服务端报错。

```
[hanson@sdw1 ~]$ psql postgres -h192.168.0.101
psql: FATAL:  no pg_hba.conf entry for host "192.168.0.102", user "hanson", database "postgres", SSL off
```

这是因为在服务端的 pg_hba.conf 文件中没有客户端的访问认证入口。加入如下内容：

```
host     all         hanson         192.168.0.102/32      md5
```
改完之后需要reload，

```
[hanson@mdw ~]$ psql postgres -c "select pg_reload_conf();"
 pg_reload_conf
----------------
 t
(1 row)
```

同时，postgres需要设置能够监听哪些端口，默认监听所有端口。

```
[hanson@mdw ~]$ cat data/master/gpseg-1/postgresql.conf
listen_addresses = '*'                 # what IP address(es) to listen on;
```


