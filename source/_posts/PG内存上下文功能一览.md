---
title: PG内存上下文功能一览
date: 2020-05-17 20:51:24
categories: PG源码
tags:
- MemoryContext
- TopMemoryContext
- PostmasterContext
- ErrorContext
- CacheMemoryContext
- MessageContext
---

PG系统实现的内存上下文的内存管理机制，对某些内存没有被任何指针指向或忘记了释放的场景，可以通过释放内存上下文来避免这些内存泄漏。 这一机制也使内存管理更加方便，而且内核开发人员不必再费尽心思地处理内存释放的工作。

下面是MemoryContext 的功能一览表：

| 内存上下文    | 何时创建 | 生命周期                                                            | 存放内容                                                                                                     | 描述                                                                                                                                                                                                           |
| ------------------ | ---------- | ----------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| TopMemoryContext   | postmaster | 系统运行期间，永远不会被重置或删除                     | 存放了所有打开的文件描述符，内存上下文的控制节点等                                      | 所有内存上下文的树根，在该上下文中分配的内存直到系统推出时才释放。                                                                                                              |
| PostmasterContext  | postmaster | fork出后端进程后被删除                                         | postmaster正常的工作环境                                                                                  | fork出后端进程后，删除该上下文。在非EXEC_BACKEND中，postmaster的pg_hba.conf和pg_ident.conf数据副本在后端进程的身份验证过程中直接使用，使用完之后删除该上下文。 |
| ErrorContext       | postmaster | 错误恢复处理后重置                                             | 错误恢复处理                                                                                               | 在任何时候都有几KB的可用内存。这样，即使后端内存不足，我们也可以确保某些内存可用于错误恢复。这允许将内存不足视为正常错误条件，而不是致命错误。 |
| CacheMemoryContext | postgres   | postgres进程运行期间，永远不会被重置或删除                     | 用于relcache、catche和相关模块的存储                                                                  | 出于调试目的，与TopMemoryContext进行了区分。CacheMemoryContext的子上下文生命周期可以较短，保存与relcache项相关联的辅助存储的最佳位置；这样我们可以轻松地释放规则解析树等，而不必依赖于构造可靠的freeObject()版本 |
| MessageContext     | postgres   | 每当PostgreMain进行下一次循环（即进行新的查询）时，该内存上下文将被重设 | 存储从前端发送过来的消息中的查询命令，以及在查询过程中产生的中间数据（例如在简单查询模式时产生的解析数和计划树） | 与每个事务和每个portal上下文是分开的，因为查询字符串可能需要比任何单个事务或portal活的更长或更短                                                                       |



# 参考：
src/backend/utils/mmgr/README